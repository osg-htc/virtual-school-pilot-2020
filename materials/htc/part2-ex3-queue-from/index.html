<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://osg-htc.org/virtual-school-pilot-2020/materials/htc/part2-ex3-queue-from/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Exercise 2.3 - OSG Virtual School Pilot 2020</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../css/extra.css" rel="stylesheet">
    <link href="../../../css/codehilite.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "HTC Exercise 2.3: Submit with \u201cqueue from\u201d", url: "#_top", children: [
              {title: "Counting Words in Files", url: "#counting-words-in-files" },
              {title: "Queue Jobs From a List of Values", url: "#queue-jobs-from-a-list-of-values" },
              {title: "Extra Challenge 1", url: "#extra-challenge-1" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <style type="text/css"> pre em { font-style: normal; background-color: yellow; } pre strong { font-style: normal; font-weight: bold; color: \#008; } </style>

<h1 id="htc-exercise-23-submit-with-queue-from">HTC Exercise 2.3: Submit with “queue from”<a class="headerlink" href="#htc-exercise-23-submit-with-queue-from" title="Permanent link">&para;</a></h1>
<p>In this exercise and the next one, you will explore more ways to use a single
submit file to submit many jobs. The goal of this exercise is to submit many
jobs from a single submit file by using the <code>queue ... from</code> syntax to read
variable values from a file.</p>
<p>In all cases of submitting many jobs from a single submit file, the key questions are:</p>
<ul>
<li>What makes each job unique? In other words, there is one job per _____?</li>
<li>So, how should you tell HTCondor to distinguish each job?</li>
</ul>
<p>For <code>queue *N*</code>, jobs are distinguished simply by the built-in "process" variable. But with the remaining <code>queue</code> forms, you help HTCondor distinguish jobs by other, more meaningful <em>custom</em> variables.</p>
<h2 id="counting-words-in-files">Counting Words in Files<a class="headerlink" href="#counting-words-in-files" title="Permanent link">&para;</a></h2>
<p>Imagine you have a collection of books, and you want to analyze how word usage varies from book to book or author to author. As mentioned in the lecture, HTCondor provides many ways to submit jobs for this task. You could create a separate submit file for each book, and submit all of the files manually, but you'd have a lot of file lines to modify each time (in particular, all five of the last lines before <code>queue</code> below):</p>
<div class="codehilite"><pre><span></span>executable              = freq.py
request_memory          = 1GB
request_disk            = 20MB
should_transfer_files   = YES
when_to_transfer_output = ON_EXIT

transfer_input_files = AAiW.txt
arguments            = AAiW.txt
output               = AAiW.out
error                = AAiW.err
log                  = AAiW.log
queue
</pre></div>


<p>This would be overly verbose and tedious. Let's do better.</p>
<h2 id="queue-jobs-from-a-list-of-values">Queue Jobs From a List of Values<a class="headerlink" href="#queue-jobs-from-a-list-of-values" title="Permanent link">&para;</a></h2>
<p>Suppose we want to modify our word-frequency analysis from a previous exercise so that it outputs only the most common <em>N</em> words of a document. However, we want to experiment with different values of <em>N</em>. </p>
<p>For this analysis, we will have a new version of the word-frequency counting
script.  First, we need a new version of the word counting program so that it
accepts an extra number as a command line argument and outputs only that many
of the most common words. Here is the new code (it's still not important that
you understand this code):</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">operator</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s1">&#39;Usage: </span><span class="si">%s</span><span class="s1"> DATA NUM_WORDS&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">input_filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">num_words</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">words</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">my_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">my_file</span><span class="p">:</span>
    <span class="n">line_words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">line_words</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
            <span class="n">words</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">words</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">sorted_words</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sorted_words</span><span class="p">[</span><span class="o">-</span><span class="n">num_words</span><span class="p">:]:</span>
    <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%8d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>To submit this program with a collection of two variable values for each run, one for the number of top words and one for the filename:</p>
<ol>
<li>Save the script as <code>wordcount-top-n.py</code>.</li>
<li>
<p>Download and unpack some books from Project Gutenberg:</p>
<div class="codehilite"><pre><span></span><span class="gp">username@learn $</span> wget http://proxy.chtc.wisc.edu/SQUID/osgschool20/books.zip
<span class="gp">username@learn $</span> unzip books.zip
</pre></div>


</li>
<li>
<p>Create a new submit file (or base it off a previous one!) named <code>wordcount-top.sub</code>, including memory and disk requests of 20 MB.</p>
</li>
<li>All of the jobs will use the same <code>executable</code> and <code>log</code> statements.</li>
<li>
<p>Update other statements to work with two variables, <code>book</code> and <code>n</code>:</p>
<div class="codehilite"><pre><span></span>output = $(book)_top_$(n).out 
error = $(book)_top_$(n).err 
transfer_input_files = $(book) 
arguments = &quot;$(book) $(n)&quot; 
queue book,n from books_n.txt
</pre></div>


<p>Note especially the changes to the <code>queue</code> statement; it now tells HTCondor to read a separate text file of <strong><em>pairs</em></strong> of values, which will be assigned to <code>book</code> and <code>n</code> respectively.</p>
</li>
<li>
<p>Create the separate text file of job variable values and save it as <code>books_n.txt</code>:</p>
<div class="codehilite"><pre><span></span>AAiW.txt, 10 
AAiW.txt, 25 
AAiW.txt, 50 
PandP.txt, 10 
PandP.txt, 25 
PandP.txt, 50
TAoSH.txt, 10
TAoSH.txt, 25
TAoSH.txt, 50
</pre></div>


<p>Note that we used 3 different values for <em>n</em> for each book.</p>
</li>
<li>
<p>Submit the file</p>
</li>
<li>Do a quick sanity check: How many jobs were submitted? How many log, output, and error files were created?</li>
</ol>
<h2 id="extra-challenge-1">Extra Challenge 1<a class="headerlink" href="#extra-challenge-1" title="Permanent link">&para;</a></h2>
<p>You may have noticed that the output of these jobs has a messy naming convention. Because our macros resolve to the filenames, including their extension (e.g., <code>AAiW.txt</code>), the output filenames contain with multiple extensions (e.g., <code>AAiW.txt.err</code>). Although the extra extension is acceptable, it makes the filenames harder to read and possibly organize. <em>Change your submit file and variable file for this exercise so that the output filenames do not include the <code>.txt</code> extension.</em></p>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../part2-ex4-queue-matching/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../part2-ex4-queue-matching/" class="btn btn-xs btn-link">
        Bonus Exercise 2.4
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../part2-ex2-queue-n/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../part2-ex2-queue-n/" class="btn btn-xs btn-link">
        Exercise 2.2
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>