<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://osg-htc.org/virtual-school-pilot-2020/materials/htc/part2-ex4-queue-matching/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Bonus Exercise 2.4 - OSG Virtual School Pilot 2020</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../css/extra.css" rel="stylesheet">
    <link href="../../../css/codehilite.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Bonus HTC Exercise 2.4: Submit With \u201cqueue matching\u201d", url: "#_top", children: [
              {title: "Counting Words in Files", url: "#counting-words-in-files" },
              {title: "Queue Jobs By Matching Filenames", url: "#queue-jobs-by-matching-filenames" },
              {title: "Extra Challenge 1", url: "#extra-challenge-1" },
              {title: "Extra Challenge 2", url: "#extra-challenge-2" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <style type="text/css"> pre em { font-style: normal; background-color: yellow; } pre strong { font-style: normal; font-weight: bold; color: \#008; } </style>

<h1 id="bonus-htc-exercise-24-submit-with-queue-matching">Bonus HTC Exercise 2.4: Submit With “queue matching”<a class="headerlink" href="#bonus-htc-exercise-24-submit-with-queue-matching" title="Permanent link">&para;</a></h1>
<p>The goal of this exercise is to submit many jobs from a single submit file by using the <code>queue ... matching</code> syntax to submit jobs with variable values derived from files in the current directory which match a specified pattern.</p>
<h2 id="counting-words-in-files">Counting Words in Files<a class="headerlink" href="#counting-words-in-files" title="Permanent link">&para;</a></h2>
<p>Returning to our book word-counting example, let's pretend that instead of
three books, we have an entire library. While we could list all of the text
files in a <code>books.txt</code> file and use <code>queue book from books.txt</code>, it could be a
tedious process, especially for tens of thousands of files. Luckily HTCondor
provides a mechanism for submitting jobs based on pattern-matched files.</p>
<h2 id="queue-jobs-by-matching-filenames">Queue Jobs By Matching Filenames<a class="headerlink" href="#queue-jobs-by-matching-filenames" title="Permanent link">&para;</a></h2>
<p>This is an example of a common scenario: We want to run one job per file, where the filenames match a certain consistent pattern. The <code>queue ... matching</code> statement is made for this scenario.</p>
<p>Let’s see this in action. First, here is a new version of the script (note, we removed the 'top n words' restriction):</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">operator</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s1">&#39;Usage: </span><span class="si">%s</span><span class="s1"> DATA&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">input_filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">words</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">my_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">my_file</span><span class="p">:</span>
    <span class="n">line_words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">line_words</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
            <span class="n">words</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">words</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">sorted_words</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">sorted_words</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%8d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>


<p>To use the script:</p>
<ol>
<li>Save it as <code>wordcount.py</code>.</li>
<li>Verify the script by running it on one book manually.</li>
<li>Create a new submit file to submit one job (pick a book file and model your submit file off of the one above)</li>
<li>
<p>Modify the following submit file statements to work for all books:</p>
<div class="codehilite"><pre><span></span>transfer_input_files = $(book) 
arguments = $(book) 
output = $(book).out 
error = $(book).err 
queue book matching *.txt
</pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As always, the order of statements in a submit file does not matter, except that the <code>queue</code> statement should be last. Also note that any submit file variable name (here, <code>book</code>, but true for <code>process</code> and all others) may be used in any mixture of upper- and lowercase letters.</p>
</div>
</li>
<li>
<p>Submit the jobs.</p>
</li>
</ol>
<p>HTCondor uses the <code>queue ... matching</code> statement to look for files in the submit directory that match the given pattern, then queues one job per match. For each job, the given variable (e.g., <code>book</code> here) is assigned the name of the matching file, so that it can be used in <code>output</code>, <code>error</code>, and other statements.</p>
<p>The result is the same as if we had written out a much longer submit file:</p>
<div class="codehilite"><pre><span></span>...

transfer_input_files = AAiW.txt
arguments = &quot;AAiW.txt&quot;
output = AAiW.txt.out
error = AAiW.txt.err
queue

transfer_input_files = PandP.txt
arguments = &quot;PandP.txt&quot;
output = PandP.txt.out
error = PandP.txt.err
queue

transfer_input_files = TAoSH.txt
arguments = &quot;TAoSH.txt&quot;
output = TAoSH.txt.out
error = TAoSH.txt.err
queue

...
</pre></div>


<p>How many jobs were created? Is this what you expected? If you ran this in the
same directory as Exercise 2.3, you may have noticed that a job was submitted
for the <code>books_n.txt</code> file that holds the variable values in the <code>queue from</code>
statement. Beware the dangers of matching more files than intended! One
solution may be to put all of the books into an <code>books</code> directory and <code>queue
matching books/*.txt</code>. Can you think of other solutions? If you have time, try one!</p>
<h2 id="extra-challenge-1">Extra Challenge 1<a class="headerlink" href="#extra-challenge-1" title="Permanent link">&para;</a></h2>
<p>In the example above, you used a single log file for all three jobs. HTCondor handles this situation with no problem; each job writes its events into the log file without getting in the way of other events and other jobs. But as you may have seen, it may be difficult for a person to understand the events for any particular job in the combined log file.</p>
<p>Create a new submit file that works just like the one above, except that each job writes its own log file.</p>
<h2 id="extra-challenge-2">Extra Challenge 2<a class="headerlink" href="#extra-challenge-2" title="Permanent link">&para;</a></h2>
<p>Between this exercise and the previous one, you have explored two of the three primary <code>queue</code> statements. How would you use the <code>queue in ... list</code> statement to accomplish the same thing(s) as one or both of the exercises?</p>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../part3-ex1-queue/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../part3-ex1-queue/" class="btn btn-xs btn-link">
        Bonus Exercise 3.1
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../part2-ex3-queue-from/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../part2-ex3-queue-from/" class="btn btn-xs btn-link">
        Exercise 2.3
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>