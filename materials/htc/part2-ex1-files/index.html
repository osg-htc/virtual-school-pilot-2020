<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://osg-htc.org/virtual-school-pilot-2020/materials/htc/part2-ex1-files/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Exercise 2.1 - OSG Virtual School Pilot 2020</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../css/extra.css" rel="stylesheet">
    <link href="../../../css/codehilite.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "HTC Exercise 2.1: Work With Input and Output Files", url: "#_top", children: [
              {title: "Viewing a Job Sandbox", url: "#viewing-a-job-sandbox" },
              {title: "Running a Job With Input Files", url: "#running-a-job-with-input-files" },
              {title: "Transferring Output Files", url: "#transferring-output-files" },
              {title: "Transferring Specific Output Files", url: "#transferring-specific-output-files" },
              {title: "Thinking About Progress So Far", url: "#thinking-about-progress-so-far" },
              {title: "References", url: "#references" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <style type="text/css"> pre em { font-style: normal; background-color: yellow; } pre strong { font-style: normal; font-weight: bold; color: \#008; } </style>

<h1 id="htc-exercise-21-work-with-input-and-output-files">HTC Exercise 2.1: Work With Input and Output Files<a class="headerlink" href="#htc-exercise-21-work-with-input-and-output-files" title="Permanent link">&para;</a></h1>
<p>The goal of this exercise is make input files available to your job on the execute machine, and return output files back. This small change significantly adds to the kinds of jobs that you can run.</p>
<h2 id="viewing-a-job-sandbox">Viewing a Job Sandbox<a class="headerlink" href="#viewing-a-job-sandbox" title="Permanent link">&para;</a></h2>
<p>Before you learn to transfer files to and from your job, it is good to understand a bit more about the environment in which your job runs.
When the HTCondor <code>starter</code> process prepares to run your job, it creates a new directory for your job and all of its files.
We call this directory the <em>job sandbox</em>, because it is your job’s private space to play.
Let’s see what is in the job sandbox for a minimal job with no special input or output files.</p>
<ol>
<li>
<p>Save the script below in a file named <code>sandbox.sh</code>:</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="nb">echo</span> <span class="s1">&#39;Date: &#39;</span> <span class="sb">`</span>date<span class="sb">`</span>
<span class="nb">echo</span> <span class="s1">&#39;Host: &#39;</span> <span class="sb">`</span>hostname<span class="sb">`</span> 
<span class="nb">echo</span> <span class="s1">&#39;Sandbox: &#39;</span> <span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span> 
ls -alF
<span class="c1"># END</span>
</pre></div>


</li>
<li>
<p>Create a submit file for this script and submit it.</p>
</li>
<li>When the job finishes, look at the contents of the output file.</li>
</ol>
<p>In the output file, note the <code>Sandbox:</code> line: That is the full path to your job sandbox for the run. It was created just for your job, and it was removed as soon as your job finished.</p>
<p>Next, look at the output that appears after the <code>Sandbox:</code> line; it is the output from the <code>ls</code> command in the script. It shows all of the files in your job sandbox, as they existed at the end of the execution of <code>sandbox.sh</code>. The files are:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.chirp.config</code></td>
<td>Configuration for an advanced feature</td>
</tr>
<tr>
<td><code>.job.ad</code></td>
<td>The job ClassAd</td>
</tr>
<tr>
<td><code>.machine.ad</code></td>
<td>The machine ClassAd</td>
</tr>
<tr>
<td><code>_condor_stderr</code></td>
<td>Saved standard error from the job</td>
</tr>
<tr>
<td><code>_condor_stdout</code></td>
<td>Saved standard output from the job</td>
</tr>
<tr>
<td><code>condor_exec.exe</code></td>
<td>The executable, renamed from <code>sandbox.sh</code></td>
</tr>
<tr>
<td><code>tmp/</code>, <code>var/tmp/</code></td>
<td>Directories in which to put temporary files</td>
</tr>
</tbody>
</table>
<p>So, HTCondor wrote copies of the job and machine ads (for use by the job, if desired), transferred your executable (<code>sandbox.sh</code>), renamed it (<code>condor_exec.exe</code>), ran it, and saved its standard output and standard error into files. Notice that your submit file, which was in the same directory on the submit machine as your executable, was <strong>not</strong> transferred, nor were any other files that happened to be in directory with the submit file.</p>
<p>Now that we know something about the sandbox, we can transfer more files to and from it.</p>
<h2 id="running-a-job-with-input-files">Running a Job With Input Files<a class="headerlink" href="#running-a-job-with-input-files" title="Permanent link">&para;</a></h2>
<p>Next, you will run a job that requires an input file. Remember, the initial job sandbox will contain only the renamed job executable, unless you tell HTCondor explicitly about every other file that needs to be transferred. Fortunately, this is easy.</p>
<p>Here is a Python script that takes the name of an input file (containing one word per line) from the command line, counts the number of times each (lowercased) word occurs in the text, and prints out the final list of words and their counts.</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s1">&#39;Usage: </span><span class="si">%s</span><span class="s1"> DATA&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">input_filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">words</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">my_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">my_file</span><span class="p">:</span>
    <span class="n">word</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="n">words</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">words</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">my_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="nb">print</span> <span class="s1">&#39;</span><span class="si">%8d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">word</span><span class="p">],</span> <span class="n">word</span><span class="p">)</span>
</pre></div>


<ol>
<li>Save the Python script in a file named <code>freq.py</code>.</li>
<li>
<p>Download the input file for the script (263K lines, ~1.4 MB) and save it in your submit directory:</p>
<div class="codehilite"><pre><span></span><span class="gp">username@learn $</span> wget http://proxy.chtc.wisc.edu/SQUID/osgschool20/intro-2.1-words.txt
</pre></div>


</li>
<li>
<p>Create a submit file for the <code>freq.py</code> executable.</p>
</li>
<li>
<p>Add a line to tell HTCondor to transfer the input file:</p>
<div class="codehilite"><pre><span></span>transfer_input_files = intro-2.1-words.txt
</pre></div>


<p>As with all submit file commands, it does not matter where this line goes, as long as it comes before the word <code>queue</code>.</p>
</li>
<li>
<p>Do not forget to add a line to name the input file as the argument to the Python script.</p>
</li>
<li>Submit the job, wait for it to finish, and check the output!</li>
</ol>
<p>If things do not work the first time, keep trying! At this point in the exercises, we are telling you less and less explicitly how to do steps that you have done before. If you get stuck, ask for help in the #intro-to-htc Slack channel.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to transfer more than one input file, list all of them on a single <code>transfer_input_files</code> command,
separated by commas.
For example, if there are three input files:</p>
<div class="codehilite"><pre><span></span>transfer_input_files = a.txt, b.txt, c.txt
</pre></div>


</div>
<h2 id="transferring-output-files">Transferring Output Files<a class="headerlink" href="#transferring-output-files" title="Permanent link">&para;</a></h2>
<p>So far, we have relied on programs that send their output to the standard output and error streams, which HTCondor captures, saves, and returns back to the submit directory. But what if your program writes one or more files for its output? How do you tell HTCondor to bring them back?</p>
<p>Let’s start by exploring what happens to files that a job creates in the sandbox.
We will use a very simple method for creating a new file: we will copy an input file to another name.</p>
<ol>
<li>Find or create a small input file (it is fine to use any small file from a previous exercise).</li>
<li>Create a submit file that transfers the input file and copies it to another name (as if doing <code>/bin/cp input.txt output.txt</code> on the command line)<ul>
<li>Make the output filename different than any filenames that are in your submit directory</li>
<li>What is the <code>executable</code> line?</li>
<li>What is the <code>arguments</code> line?</li>
<li>How do you tell HTCondor to transfer the input file?</li>
<li>As always, use <code>output</code>, <code>error</code>, and <code>log</code> filenames that are different from previous exercises</li>
</ul>
</li>
<li>Submit the job and wait for it to finish.</li>
</ol>
<p>What happened? Can you tell what HTCondor did with the output file that was created (did it end up back on the submit server?), after it was created in the job sandbox? Look carefully at the list of files in your submit directory now.</p>
<h2 id="transferring-specific-output-files">Transferring Specific Output Files<a class="headerlink" href="#transferring-specific-output-files" title="Permanent link">&para;</a></h2>
<p>As you saw in the last exercise, by default HTCondor transfers files that are created in the job sandbox back to the submit directory when the job finishes. In fact, HTCondor will also transfer back <strong>changed</strong> input files, too. But, this only works for files that are in the top-level sandbox directory, and <strong>not</strong> for ones contained in subdirectories.</p>
<p>What if you want to bring back only <strong>some</strong> output files, or output files contained in subdirectories?</p>
<p>Here is a shell script that creates several files, including a copy of an input file in a new subdirectory:</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -ne <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> INPUT&quot;</span><span class="p">;</span> <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span> <span class="k">fi</span>
date &gt; output-timestamp.txt
cal &gt; output-calendar.txt
mkdir subdirectory
cp <span class="nv">$1</span> subdirectory/backup-<span class="nv">$1</span>
</pre></div>


<p>First, let’s confirm that HTCondor does not bring back the output file in the subdirectory:</p>
<ol>
<li>Save the shell script in a file named <code>output.sh</code>.</li>
<li>Write a submit file that transfers an input file and runs <code>output.sh</code> on it (passing the filename as an argument).</li>
<li>Submit the job, wait for it to finish, and examine the contents of your submit directory.</li>
</ol>
<p>Suppose you decide that you want only the timestamp output file and all files in the subdirectory, but not the calendar output file. You can tell HTCondor to transfer these specific files:</p>
<div class="codehilite"><pre><span></span>transfer_output_files = output-timestamp.txt, subdirectory/
</pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the trailing slash (<code>/</code>) on the subdirectory?
That tells HTCondor to transfer back <strong>the files</strong> contained in the subdirectory, but not the directory itself;
the files will be written directly into the submit directory.
If you want HTCondor to transfer back an entire directory, leave off the trailing slash.</p>
</div>
<ol>
<li>Remove all output files from the previous run, including <code>output-timestamp.txt</code> and <code>output-calendar.txt</code>.</li>
<li>Copy the previous submit file that ran <code>output.sh</code> and add the <code>transfer_output_files</code> line from above.</li>
<li>Submit the job, wait for it to finish, and examine the contents of your submit directory.</li>
</ol>
<p>Did it work as you expected?</p>
<h2 id="thinking-about-progress-so-far">Thinking About Progress So Far<a class="headerlink" href="#thinking-about-progress-so-far" title="Permanent link">&para;</a></h2>
<p>At this point, you can do just about everything that you need in order to run jobs on a local HTC pool. You can identify the executable, arguments, and input files, and you can get output back from the job. This is a big achievement!</p>
<p>In some ways, everything after this exercise shows you how to submit multiple jobs at once and makes it easier to run certain kinds of jobs and deal with certain kinds of situations.</p>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<p>There are many more details about HTCondor’s file transfer mechanism not covered here.
For more information, read <a href="https://htcondor.readthedocs.io/en/latest/users-manual/file-transfer.html">"Submitting Jobs Without a Shared Filesystem"</a> in the HTCondor Manual.</p>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../part2-ex2-queue-n/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../part2-ex2-queue-n/" class="btn btn-xs btn-link">
        Exercise 2.2
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../part1-ex7-compile/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../part1-ex7-compile/" class="btn btn-xs btn-link">
        Bonus Exercise 1.7
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>