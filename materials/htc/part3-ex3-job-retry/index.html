<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://osg-htc.org/virtual-school-pilot-2020/materials/htc/part3-ex3-job-retry/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Bonus Exercise 3.3 - OSG Virtual School Pilot 2020</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../css/extra.css" rel="stylesheet">
    <link href="../../../css/codehilite.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Bonus HTC Exercise 3.3: Retries", url: "#_top", children: [
              {title: "Bad Job", url: "#bad-job" },
              {title: "Retrying Failed Jobs", url: "#retrying-failed-jobs" },
              {title: "A (Too) Long Running Job", url: "#a-too-long-running-job" },
              {title: "Bonus Exercise", url: "#bonus-exercise" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <style type="text/css"> pre em { font-style: normal; background-color: yellow; } pre strong { font-style: normal; font-weight: bold; color: \#008; } </style>

<h1 id="bonus-htc-exercise-33-retries">Bonus HTC Exercise 3.3: Retries<a class="headerlink" href="#bonus-htc-exercise-33-retries" title="Permanent link">&para;</a></h1>
<p>The goal of this exercise is to demonstrate running a job that intermittently fails and thus could benefit from having HTCondor automatically retry it.</p>
<p>This first part of the exercise should take only a few minutes, and is designed to setup the next exercises.</p>
<h2 id="bad-job">Bad Job<a class="headerlink" href="#bad-job" title="Permanent link">&para;</a></h2>
<p>Let’s assume that a colleague has shared with you a program, and it fails once in a while. In the real world, we would probably just fix the program, but what if you cannot change the software? Unfortunately, this situation happens more often than we would like.</p>
<p>Below is a Python script that fails once in a while.
We will not fix it, but instead use it to simulate a program that can fail and that we <strong>cannot</strong> fix.</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># murphy.py simulates a real program with real problems</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># For one out of every three attempts, simulate a runtime error</span>
<span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Intentionally don&#39;t print any output</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All work done correctly&quot;</span><span class="p">)</span>

<span class="c1"># By convention, zero exit code means success</span>
<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>


<p>Let’s see what happens when a program like this one is run in HTCondor.</p>
<ol>
<li>In a new directory for this exercise, save the script above as <code>murphy.py</code>.</li>
<li>Write a submit file for the script; <code>queue 20</code> instances of the job and be sure to ask for 20 MB of memory and disk.</li>
<li>Submit the file, note the ClusterId, and wait for the jobs to finish.</li>
</ol>
<p>What output do you expect? What output did you get? If you are curious about the exit code from the job, it is saved in completed jobs in <code>condor_history</code> in the <code>ExitCode</code> attribute. The following command will show the <code>ExitCode</code> for a given cluster of jobs:</p>
<div class="codehilite"><pre><span></span><span class="gp">username@learn $</span> condor_history &lt;CLUSTER&gt; -af ProcId ExitCode
</pre></div>


<p>(Be sure to replace <code>&lt;cluster&gt;</code> with your actual cluster ID. The command may take a minute or so to complete.)</p>
<p>How many of the jobs succeeded? How many failed?</p>
<h2 id="retrying-failed-jobs">Retrying Failed Jobs<a class="headerlink" href="#retrying-failed-jobs" title="Permanent link">&para;</a></h2>
<p>Now let’s see if we can solve the problem of jobs that fail once in a while. In this particular case, if HTCondor runs a failed job again, it has a good chance of succeeding. Not all failing jobs are like this, but in this case it is a reasonable assumption.</p>
<p>From the lecture materials, implement the <code>max_retries</code> feature to retry any job with a non-zero exit code up to 5 times, then resubmit the jobs. Did your change work?</p>
<p>After the jobs have finished, examine the log file(s) to see what happened in detail. Did any jobs need to be restarted? Another way to see how many restarts there were is to look at the <code>NumJobStarts</code> attribute of a completed job with the <code>condor_history</code> command, in the same way you looked at the <code>ExitCode</code> attribute earlier. Does the number of retries seem correct? For those jobs which did need to be retried, what is their <code>ExitCode</code>; and what about the <code>ExitCode</code> from earlier execution attempts?</p>
<h2 id="a-too-long-running-job">A (Too) Long Running Job<a class="headerlink" href="#a-too-long-running-job" title="Permanent link">&para;</a></h2>
<p>Sometimes, an ill-behaved job will get stuck in a loop and run forever, instead of exiting with a failure code, and it may just need to be re-run (or run on a different execute server) to complete without getting stuck. We can modify our Python program to simulate this kind of bad job with the following file:</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># murphy.py simulate a real program with real problems</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># For one out of every three attempts, simulate an &quot;infinite&quot; loop</span>
<span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Intentionally don&#39;t print any output</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3600</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All work done correctly&quot;</span><span class="p">)</span>

<span class="c1"># By convention, zero exit code means success</span>
<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>


<p>Let’s see what happens when a program like this one is run in HTCondor.</p>
<ol>
<li>Save the script to a new file named <code>murphy2.py</code>.</li>
<li>Copy your previous submit file to a new name and change the <code>executable</code> to <code>murphy2.py</code>.</li>
<li>If you like, submit the new file — but after a while be sure to remove the whole cluster to clear out the “hung” jobs.</li>
<li>
<p>Now try to change the submit file to automatically remove any jobs that <strong>run</strong> for more than one minute. You can make this change with just a single line in your submit file</p>
<div class="codehilite"><pre><span></span>periodic_remove = (JobStatus == 2) &amp;&amp; ( (CurrentTime - EnteredCurrentStatus) &gt; 60 )
</pre></div>


</li>
<li>
<p>Submit the new file. Do the long running jobs get removed? What does <code>condor_history</code> show for the cluster after all jobs are done? Which job status (i.e. idle, held, running) do you think <code>JobStatus == 2</code> corresponds to?</p>
</li>
</ol>
<h2 id="bonus-exercise">Bonus Exercise<a class="headerlink" href="#bonus-exercise" title="Permanent link">&para;</a></h2>
<p>If you have time, edit your submit file so that instead of removing long running jobs,
HTCondor will automatically put the long-running job on hold,
and then automatically release it.</p>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../osg/ex1-submit-refresher/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../osg/ex1-submit-refresher/" class="btn btn-xs btn-link">
        Exercise 1
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../part3-ex2-status/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../part3-ex2-status/" class="btn btn-xs btn-link">
        Bonus Exercise 3.2
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>