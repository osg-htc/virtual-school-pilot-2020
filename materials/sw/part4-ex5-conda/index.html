<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://osg-htc.org/virtual-school-pilot-2020/materials/sw/part4-ex5-conda/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Exercise 4.5 - OSG Virtual School Pilot 2020</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../css/extra.css" rel="stylesheet">
    <link href="../../../css/codehilite.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Software Exercise 4.5: Using Conda Environments (Beta!)", url: "#_top", children: [
              {title: "Introduction", url: "#introduction" },
              {title: "Create and Pack a Conda Environment", url: "#create-and-pack-a-conda-environment" },
              {title: "Submit a Job", url: "#submit-a-job" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <style type="text/css"> pre em { font-style: normal; background-color: yellow; } pre strong { font-style: normal; font-weight: bold; color: #008; } </style>

<h1 id="software-exercise-45-using-conda-environments-beta">Software Exercise 4.5: Using Conda Environments (Beta!)<a class="headerlink" href="#software-exercise-45-using-conda-environments-beta" title="Permanent link">&para;</a></h1>
<p>This exercise covers how to use Python environments managed by miniconda. </p>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>Many Python users manage their Python installation and environments with either the
<code>Anaconda</code> or <code>miniconda</code> distributions. These distribution tools are great 
for creating portable Python installations and can be used on HTC systems with 
some help from a tool called <code>conda pack</code>. </p>
<h2 id="create-and-pack-a-conda-environment">Create and Pack a Conda Environment<a class="headerlink" href="#create-and-pack-a-conda-environment" title="Permanent link">&para;</a></h2>
<p>(For a generic version of these instructions, see the <a href="http://chtc.cs.wisc.edu/conda-installation">CHTC User Guide</a>)</p>
<ol>
<li>
<p>Our first step is to create a miniconda installation on the submit server. </p>
<ol>
<li>Log into either <code>learn.chtc.wisc.edu</code> or <code>login04.osgconnect.net</code></li>
<li>
<p>Download the latest Linux <a href="https://docs.conda.io/en/latest/miniconda.html">miniconda installer</a></p>
<div class="codehilite"><pre><span></span><span class="gp">user@login $</span> wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
</pre></div>


</li>
<li>
<p>Run the installer to install miniconda; you'll need to accept the license terms and 
you can use the default installation location: </p>
<div class="codehilite"><pre><span></span><span class="gp">[user@login]$</span> sh Miniconda3-latest-Linux-x86_64.sh
</pre></div>


</li>
<li>
<p>At the end, you can choose whether or 
not to "initialize Miniconda3 by running conda init?" The default is no; you would 
then run the <code>eval</code> command listed by the installer to "activate" Miniconda. If you
choose "no" you'll want to save this command so that you can reactivate the 
Miniconda installation when needed in the future.</p>
</li>
</ol>
</li>
<li>
<p>Next we'll create our conda "environment" with <code>numpy</code> (we've called the environment "py3-numpy"): </p>
<div class="codehilite"><pre><span></span><span class="gp gp-VirtualEnv">(base)</span><span class="gp">[user@login]$</span> conda create -n py3-numpy
<span class="gp gp-VirtualEnv">(base)</span><span class="gp">[user@login]$</span> conda activate py3-numpy
<span class="gp gp-VirtualEnv">(py3-numpy)</span><span class="gp">[user@login]$</span> conda install numpy
</pre></div>


</li>
<li>
<p>Once everything is installed, deactivate the environment to go back to the 
Miniconda "base" environment.</p>
<div class="codehilite"><pre><span></span><span class="gp gp-VirtualEnv">(py3-numpy)</span><span class="gp">[user@login]$</span> conda deactivate
</pre></div>


</li>
<li>
<p>We'll now install a tool that will pack up the just created conda environment 
so we can run it elsewhere. Make sure that your job's Miniconda environment is created, but deactivated, so 
that you're in the "base" Miniconda environment, then run: </p>
<div class="codehilite"><pre><span></span><span class="gp gp-VirtualEnv">(base)</span><span class="gp">[user@login]$</span> conda install -c conda-forge conda-pack
</pre></div>


<p>Enter <code>y</code> when it asks you to install. </p>
</li>
<li>
<p>Finally, we will run the <code>conda pack</code> command, which will automatically create a 
tar.gz file with our environment: </p>
<div class="codehilite"><pre><span></span><span class="gp gp-VirtualEnv">(base)</span><span class="gp">[user@login]$</span> conda pack -n py3-numpy
</pre></div>


</li>
</ol>
<h2 id="submit-a-job">Submit a Job<a class="headerlink" href="#submit-a-job" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Create a copy of the <code>rand_array.py</code> script from the <a href="../../../materials/sw/part4-ex4-docker-build">Docker Build Exercise</a></p>
</li>
<li>
<p>The executable for this job will need to be a wrapper script. What steps do you 
think need to be included? Write down a rough draft, then compare with the following script. </p>
</li>
<li>
<p>Create a wrapper script like the following: </p>
<div class="codehilite"><pre><span></span>#!/bin/bash

set -e

export PATH
mkdir py3-numpy
tar -xzf py3-numpy.tar.gz -C py3-numpy
. py3-numpy/bin/activate

python3 rand_array.py
</pre></div>


</li>
<li>
<p>What needs to be included in your submit file for the job to run successfully? Try 
yourself and then check the suggestions in the next point. </p>
</li>
<li>
<p>In your submit file, make sure to have the following: </p>
<ul>
<li>Your executable should be the the bash script you created in the previous step. </li>
<li>Remember to transfer your Python script and the environment <code>tar.gz</code> file via
 <code>transfer_input_files</code>. </li>
</ul>
</li>
<li>
<p>Submit the job and see what happens!</p>
</li>
</ol>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../data/part1-ex1-data-needs/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../data/part1-ex1-data-needs/" class="btn btn-xs btn-link">
        Exercise 1.1
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../part4-ex4-docker-build/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../part4-ex4-docker-build/" class="btn btn-xs btn-link">
        Exercise 4.4
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>