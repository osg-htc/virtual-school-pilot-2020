<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://osg-htc.org/virtual-school-pilot-2020/materials/sw/part2-ex3-python/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Exercise 2.3 - OSG Virtual School Pilot 2020</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <link href="../../../css/extra.css" rel="stylesheet">
    <link href="../../../css/codehilite.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Software Exercise 2.3: Using Python, Pre-Built", url: "#_top", children: [
              {title: "Background", url: "#background" },
              {title: "Interactive Job for Pre-Building", url: "#interactive-job-for-pre-building" },
              {title: "Python Script", url: "#python-script" },
              {title: "Wrapper Script", url: "#wrapper-script" },
              {title: "Submit File", url: "#submit-file" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    <style type="text/css"> pre em { font-style: normal; background-color: yellow; } pre strong { font-style: normal; font-weight: bold; color: #008; } </style>

<h1 id="software-exercise-23-using-python-pre-built">Software Exercise 2.3: Using Python, Pre-Built<a class="headerlink" href="#software-exercise-23-using-python-pre-built" title="Permanent link">&para;</a></h1>
<p>In this exercise, you will install Python, package your installation, and then use it to run jobs. It should take about 20 minutes.</p>
<h2 id="background">Background<a class="headerlink" href="#background" title="Permanent link">&para;</a></h2>
<p>We chose Python as the language for this example because: a) it is a common language used for scientific computing and b) it has a straightforward installation process and is fairly portable.</p>
<p>Running any Python script requires an installation of the Python interpreter. The Python interpreter is what we're using when we type <code>python</code> at the command line. In order to run Python jobs on a distributed system, you will need to install the Python interpreter (what we often refer to as just "installing Python"), within the job, then run your Python script.</p>
<p>There are two installation approaches. The approach we will cover in this exercise is that of "pre-building" the installation. We will install Python to a specific directory, and then create a tarball of that installation directory. We can then use our tarball within jobs to run Python scripts.</p>
<h2 id="interactive-job-for-pre-building">Interactive Job for Pre-Building<a class="headerlink" href="#interactive-job-for-pre-building" title="Permanent link">&para;</a></h2>
<p>The first step in our job process is building a Python installation that we can package up.</p>
<ol>
<li>Create a directory for this exercise on <code>learn.chtc.wisc.edu</code> and <code>cd</code> into it.</li>
<li>
<p>Download the Python source code from <a href="https://www.python.org/">https://www.python.org/</a>. </p>
<div class="codehilite"><pre><span></span><span class="gp">username@learn $</span> wget https://www.python.org/ftp/python/3.7.0/Python-3.7.0.tgz
</pre></div>


</li>
<li>
<p>Of our options - submit server, interactive job, personal computer - which should we use for this installation/packaging process? Once you have a guess, move to the next step.</p>
</li>
<li>
<p>Due to the number of people on our submit server, we shouldn't use the submit server. Your own computer probably doesn't have the right operating system. The best place to install will be an interactive job. For this job, we can use the same interactive submit file as Exercise 2.2, with one change. What is it?</p>
</li>
<li>
<p>Make a copy of the interactive submit file from <a href="../../../materials/sw/part2-ex2-prepackaged">Exercise 2.2</a> and change the <code>transfer_input_files</code> line to the Python tarball you just downloaded. Then submit it using the <code>-i</code> flag. </p>
<div class="codehilite"><pre><span></span><span class="gp">username@learn $</span> condor_submit -i build.submit
</pre></div>


</li>
<li>
<p>Once the interactive job begins, we can start our installation process. First, we have to determine how to install Python to a specific location in our working directory.</p>
<ol>
<li>Untar the Python source tarball and look at the <code>README.rst</code> file in the <code>Python-3.7.0</code> directory.  You'll want to look for the "Build Instructions" header.  What will the main installation steps be?  What command is required for the final installation?  Once you've tried to answer these questions, move to the next step.</li>
<li>
<p>There are some basic installation instructions near the top of the <code>README</code>. Based on that short introduction, we can see the main steps of installation will be: </p>
<div class="codehilite"><pre><span></span>./configure
make
make test
sudo make install
</pre></div>


<p>This three-stage process (configure, make, make install) is a common  way to install many software packages.   The default installation  location for Python requires <code>sudo</code> (administrative privileges) to install. However, we'd like to install to a specific location in the working directory  so that we can compress that installation directory into a tarball. </p>
</li>
<li>
<p>You can often use an option called <code>-prefix</code> with the <code>configure</code> script to change the default installation directory. Let's see if the Python <code>configure</code> script has this option by using the "help" option (as suggested in the <code>README.rst</code> file): </p>
<div class="codehilite"><pre><span></span><span class="gp">username@host $</span> ./configure --help
</pre></div>


<p>Sure enough, there's a list of all the different options that can be passed to the <code>configure</code> script, which includes <code>--prefix</code>.  (To see the <code>--prefix</code> option, you may need to scroll towards the top of the output.)  Therefore, we can use the  <code>$PWD</code> command in order to set the path correctly to a custom installation directory. </p>
</li>
</ol>
</li>
<li>
<p>Now let's actually install Python!</p>
<ol>
<li>
<p><strong>From the job's main working directory</strong>, create a directory to hold the installation. </p>
<div class="codehilite"><pre><span></span><span class="gp">username@host $</span> <span class="nb">cd</span> <span class="nv">$_CONDOR_SCRATCH_DIR</span>
<span class="gp">username@host $</span> mkdir python
</pre></div>


</li>
<li>
<p>Move into the <code>Python-3.7.0</code> directory and run the installation commands. These may take a few minutes each. </p>
<div class="codehilite"><pre><span></span><span class="gp">username@host $</span> <span class="nb">cd</span> Python-3.7.0
<span class="gp">username@host $</span> ./configure --prefix<span class="o">=</span><span class="nv">$PWD</span>/../python
<span class="gp">username@host $</span> make
<span class="gp">username@host $</span> make install
</pre></div>


<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The installation instructions in the <code>README.rst</code> file have a <code>make test</code> step 
between the <code>make</code> and <code>make install</code> steps.  As this step isn't strictly necessary (and takes a long time), it's been omitted above.  </p>
</div>
</li>
<li>
<p>If I move back to the main job working directory, and look in the <code>python</code> subdirectory, I should see a Python installation. </p>
<div class="codehilite"><pre><span></span><span class="gp">username@host $</span> <span class="nb">cd</span> ..
<span class="gp">username@host $</span> ls python/
<span class="go">bin  include  lib  share</span>
</pre></div>


</li>
<li>
<p>I have successfully created a self-contained Python installation. Now it just needs to be tarred up! </p>
<div class="codehilite"><pre><span></span><span class="gp">username@host $</span> tar -czf prebuilt_python.tar.gz python/
</pre></div>


</li>
</ol>
</li>
<li>
<p>Before exiting, we might want to know how we installed Python for later reference.  Enter the following commands to save our history to a file: </p>
<div class="codehilite"><pre><span></span><span class="gp">username@host $</span> <span class="nb">history</span> &gt; python_install.txt
</pre></div>


</li>
<li>
<p>Exit the interactive job. </p>
<div class="codehilite"><pre><span></span><span class="gp">username@host $</span> <span class="nb">exit</span>
</pre></div>


</li>
</ol>
<h2 id="python-script">Python Script<a class="headerlink" href="#python-script" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Create a script with the following lines called <code>fib.py</code>. </p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Usage: </span><span class="si">%s</span><span class="s1"> MAXIMUM&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">maximum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">n1</span> <span class="o">=</span> <span class="n">n2</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">while</span> <span class="n">n2</span> <span class="o">&lt;=</span> <span class="n">maximum</span><span class="p">:</span>
    <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The greatest Fibonacci number up to </span><span class="si">%d</span><span class="s1"> is </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maximum</span><span class="p">,</span> <span class="n">n1</span><span class="p">))</span>
</pre></div>


</li>
<li>
<p>What command line arguments does this script take? Try running it on the submit server.</p>
</li>
</ol>
<h2 id="wrapper-script">Wrapper Script<a class="headerlink" href="#wrapper-script" title="Permanent link">&para;</a></h2>
<p>We now have our Python installation and our Python script - we just need to write a wrapper script to run them.</p>
<ol>
<li>What steps do you think the wrapper script needs to perform? Create a file called <code>run_fib.sh</code> and write them out in plain English before moving to the next step.</li>
<li>Our script will need to<ol>
<li>untar our <code>prebuilt_python.tar.gz</code> file</li>
<li>access the <code>python</code> command from our installation to run our <code>fib.py</code> script</li>
</ol>
</li>
<li>Try turning your plain English steps into commands that the computer can run.</li>
<li>
<p>Your final <code>run_fib.sh</code> script should look something like this: </p>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>

tar -xzf prebuilt_python.tar.gz 
python/bin/python3 fib.py <span class="m">90</span>
</pre></div>


<p>or</p>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>

tar -xzf prebuilt_python.tar.gz 
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/python/bin:<span class="nv">$PATH</span> 
python3 fib.py <span class="m">90</span>
</pre></div>


</li>
<li>
<p>Make sure your <code>run_fib.sh</code> script is executable.</p>
</li>
</ol>
<h2 id="submit-file">Submit File<a class="headerlink" href="#submit-file" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Make a copy of a previous submit file in your local directory (the OpenBugs submit file could be a good starting point). What changes need to be made to run this Python job? </p>
</li>
<li>
<p>Modify your submit file, then make sure you've included the key lines below: </p>
<div class="codehilite"><pre><span></span>executable = run_fib.sh
transfer_input_files = fib.py, prebuilt_python.tar.gz
</pre></div>


</li>
<li>
<p>Submit the job using <code>condor_submit</code>. </p>
</li>
<li>
<p>Check the <code>.out</code> file to see if the job completed.</p>
</li>
</ol>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../part2-ex4-matlab/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../part2-ex4-matlab/" class="btn btn-xs btn-link">
        Exercise 2.4
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../part2-ex2-prepackaged/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../part2-ex2-prepackaged/" class="btn btn-xs btn-link">
        Exercise 2.2
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>